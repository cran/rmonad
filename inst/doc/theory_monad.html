<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Zebulun Arendsee" />


<title>rmonad: Where’s the monad?</title>






<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore"><code>rmonad</code>: Where’s the monad?</h1>
<h4 class="author"><em>Zebulun Arendsee</em></h4>



<p>This work is funded by the National Science Foundation grant <a href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=1546858">NSF-IOS 1546858</a>.</p>
<p>You probably don’t need to read this. Certainly you should read the <code>introduction</code> vignette first.</p>
<p>** This vignette is under construction **</p>
<p>This vignette consists of four parts. First I will describe the monad hidden in the R runtime. Second, I will describe how <code>rmonad</code> can serve as a replacement. Third, I will contrast the monadic pipelines of <code>rmonad</code> with the compositional pipelines of <code>magrittr</code>. Finally, I will discuss <code>rmonad</code> from the Haskell perspective.</p>
<p>I will introduce the concept of a monad incrementally through the first three sections. However, monads in the programming context are notoriously difficult to understand. If you are not familiar with them, you may try studying a few online tutorials first. That said, <code>rmonad</code> can be used without understanding monads.</p>
<div id="the-hidden-r-monad" class="section level2">
<h2>The hidden R monad</h2>
<p>What does <code>sqrt</code> do? You may answer, “return the square root of an input”. But this is not quite right. The function <code>sqrt</code> maps an input to a set of possible values:</p>
<ul>
<li>when x is numeric and <span class="math inline">\(x \ge 0\)</span> : <span class="math inline">\(\sqrt{x}\)</span></li>
<li>when x is numeric and <span class="math inline">\(x &lt; 0\)</span> : <code>NaN</code> with a warning</li>
<li>when x is not numeric : an error that stops evaluation and dumps a message</li>
</ul>
<p>Every R function maps a pure value to a computational context with possible undefined behavior and side effects. We can describe the action of a function abstractly as</p>
<pre><code>a -&gt; m b</code></pre>
<p>Where <code>a</code> is the pure input value, <code>b</code> is the pure output value, and <code>m</code> represents the output context. The <code>sqrt</code> function can be described as <code>number* -&gt; m number</code>. Where <code>number*</code> represents an input value that <em>should</em> be a number, but, since R is dynamic, may be anything. <code>m numeric</code> represents a context that holds either a number or some effect.</p>
<p>When we build a pipeline, we chain many functions together. Say, for example, we have the expression:</p>
<pre><code>sqrt(sum(x))</code></pre>
<p>Borrowing a bit of Haskell syntax</p>
<pre><code>sqrt :: numeric* -&gt; m numeric
sum  :: numeric* -&gt; m numeric</code></pre>
<p><code>numeric*</code> represents something that should be numeric. Again, since R is dynamically typed, we have no guaranttees that the input actually is numeric. Each function takes a pure value and maps to a value wrapped in a context. <code>sum(x)</code> outputs <code>m numeric*</code>, but <code>sqrt</code> wants a <code>numeric*</code>. We need a function to mediate this. A function with the form:</p>
<pre><code>bind :: (m numeric*) -&gt; (numeric* -&gt; m numeric*) -&gt; (m numeric) 
           ^                ^                           ^
          /                /                           /
      sum(x)            sqrt                   sqrt(sum(x))</code></pre>
<p>We can express this more generally as</p>
<pre><code>bind :: m1 a -&gt; (a -&gt; m2 b) -&gt; m3 b</code></pre>
<p>Where <code>a</code> and <code>b</code> are data types. <code>m1</code>, <code>m2</code> and <code>m3</code> are contexts. Every bind operation takes 1) a value in a context (<code>m1 a</code>) and 2) a function that maps that value to <code>m2 b</code>. The prior state <code>m1</code>, as well as the intermediate state <code>m2</code>, are in the scope of the <code>bind</code> function. This allows contextual information to propagate from the <code>m1</code> to <code>m3</code>.</p>
<p>A monad is a pattern consisting of a context <code>m</code>, two functions, and three laws. The functions are <code>bind</code> and <code>return</code> (not to be confused with the <code>return</code> used to terminate a function). <code>bind</code> we have already seen. <code>return</code> takes a pure value and lifts it into a context. <code>return</code> has the form <code>a -&gt; m a</code>.</p>
<p>Before we cover the monad laws, and before we learn exactly what the monad is in the <code>rmonad</code> context, we will walk step by step through one example. <code>rmonad</code> uses the infix operator <code>%&gt;&gt;%</code> as <code>bind</code> (<code>rmonad</code>’s <code>%&gt;&gt;%</code> corresponds to Haskell’s <code>&gt;&gt;=</code>).</p>
</div>
<div id="rmonad" class="section level2">
<h2><code>rmonad</code></h2>
<p>The goal of <code>rmonad</code> is to ditch the existing impure R monad and replace it with a clean explicit monad.</p>
<pre><code>x %&gt;&gt;% sum %&gt;&gt;% sqrt</code></pre>
<p>The initial %&gt;&gt;% operators acts as both a <code>return</code> and <code>bind</code> function. It first evaluates the</p>
<p><code>m b</code> is dependent on <code>m a</code>, not just on <code>a</code>. The <code>bind</code> function can pass information from one step in the pipeline <code>m a</code> to the next <code>m b</code>.</p>
<p><code>m2 b</code> is equal to <code>m3 b</code> only for the trivial case where the context is <code>identity</code>.</p>
<p>R users normally rely on the R session to automatically perform these binds.</p>
<p>But what exactly is <code>m</code>? In an R session, the R runtime handles errors. If one function raises an error, the error is propagated to functions that use its input.</p>
<p>In <code>rmonad</code>, the <code>m</code> is an object, that catches all undefined behavior.</p>
</div>
<div id="rmonad-versus-magrittr" class="section level2">
<h2><code>rmonad</code> versus magrittr</h2>
<p>To understand the monadic nature of <code>rmonad</code> it is useful to compare it to <code>magrittr</code>. In <code>magrittr</code>, the expression <code>x %&gt;% foo %&gt;% bar</code> is the same as <code>bar(foo(x))</code>. From a monadic point of view, <code>x</code> is first implicitly raised into an ‘Identity’ monad (which is quite formless here) <code>m1 x</code>. Then</p>
<pre><code>bind :: m1 x -&gt; (x -&gt; m2 y) -&gt; m3 y</code></pre>
<p>The <code>bind</code> function above executes <code>foo</code> on <code>x</code>, yielding <code>m2 y</code>. It then reduces this to <code>m3 y</code> in the presence of <code>m1</code>. But <code>magrittr</code> passes no information from <code>m1</code> to <code>m3</code>. The pipeline is context indepent.</p>
<p>In <code>rmonad</code>, the pipeline <code>x %&gt;&gt;% foo %&gt;&gt;% bar</code> will pass a record of past events at each bind operation, thus incrementally building a graph of the pipeline.</p>
</div>
<div id="rmonad-for-haskellers" class="section level2">
<h2><code>rmonad</code> for Haskellers</h2>
<p>The name <code>rmonad</code> is a nod to <code>Xmonad</code> (no relation to the Restricted Monad package). Where <code>Xmonad</code> wraps the X window system, <code>rmonad</code> wraps evaluation of R expressions.</p>
<p>Only a few R expressions are pure. If a function is given an invalid input at runtime (e.g. <code>sqrt(&quot;wtf&quot;)</code>), it will die with a message printed to stderr. <code>rmonad</code> wraps all R calls in a monad, intercepting all messages, so that the result of a computation is returned as a pure object.</p>
<p>The ‘R monad’ is one monad to rule the all. There is no monad stack and no support for monad transformers. In addition to error handling, The monad stores the history of every previous operation. It also performs basic benchmarking, recording the time required for each operation and the size of the returned object. All this weight might seem like a performance killer, but R programmers are used to function calls being slow, so if they care about performance, they wouldn’t use a function in a tight loop anyways.</p>
<p>The <code>return</code> function is a little complex in <code>rmonad</code>. It is a special case of the <code>as_monad</code> function:</p>
<pre><code>as_monad = a -&gt; m b</code></pre>
<p>Where <code>a</code> can be one of three types</p>
<ol style="list-style-type: decimal">
<li><p>an unevaluated R expression - <code>as_monad</code> evaluates the expression, capturing any exceptions, warnings or messages. <code>as_monad</code> is used inside the <code>bind</code> function in this capacity.</p></li>
<li><p>a pure R value - acts as <code>return</code></p></li>
</ol>
<p>The <code>%&gt;&gt;%</code> operator is like the Haskell <code>&gt;&gt;=</code> operator, but with some of the sloppiness expected of a dynamic language:</p>
<pre><code>%&gt;&gt;% :: m a -&gt; (a -&gt; m b) -&gt; m b
      | a -&gt; (a -&gt; m b) -&gt; m b
      | (a -&gt; r b) -&gt; (a -&gt; m b) -&gt; m b</code></pre>
<p><code>%&gt;&gt;%</code> differs from <code>&gt;&gt;=</code> in that <code>%&gt;&gt;%</code> automatically loads the left-hand-side value into a monad.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
