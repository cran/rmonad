<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Zebulun Arendsee" />


<title>Rmonad: Where’s the monad?</title>






<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Rmonad: Where’s the monad?</h1>
<h4 class="author"><em>Zebulun Arendsee</em></h4>



<p>This vignette consists of four parts. First I will describe the cryptomonad hidden in the R runtime. Second, I will describe how Rmonad can serve as a replacement. Third, I will contrast the monadic pipelines of Rmonad with the compositional pipelines of <code>magrittr</code>. Finally, I will discuss Rmonad from the Haskell perspective.</p>
<p>I will introduce the concept of a monad incrementally through the first three sections. However, monad’s in the programming context are notoriously difficult to understand. If you are not familiar with them, you may try studying a few online tutorials first. That said, <code>rmonad</code> can be used without understanding monads.</p>
<div id="the-r-cryptomonad" class="section level2">
<h2>The R cryptomonad</h2>
<p>What does <code>sqrt</code> do? You may answer, “return the square root of an input”. But this is not quite right. The function <code>sqrt</code> maps an input to a set of possible values.</p>
<ul>
<li>when x is numeric and <span class="math inline">\(x &gt; 0\)</span> : <span class="math inline">\(\sqrt{x}\)</span></li>
<li>when x is numeric and <span class="math inline">\(x \le 0\)</span> : <code>NA</code> and a warning effect</li>
<li>when x is not numeric : an error effect that propagates downstream</li>
</ul>
<p>Every R function maps a pure value to a computational context with possible undefined behavior and side effects. We can describe the action of a function abstractly as</p>
<pre><code>a -&gt; m b</code></pre>
<p>Where <code>a</code> is the pure input value, <code>b</code> is the pure output value, and <code>m</code> represents the output context. The <code>sqrt</code> function can be described as <code>number* -&gt; m number</code>. Where <code>number*</code> represents an input value that <em>should</em> be a number, but, since R is dynamic, may be anything. <code>m numeric</code> represents a context that holds either a number or some effect.</p>
<p>When we build a pipeline, we chain many functions together. Say, for example, we have the expression:</p>
<pre><code>sqrt(sum(x))</code></pre>
<p>Borrowing a bit of Haskell syntax</p>
<pre><code>sqrt :: numeric* -&gt; m numeric
sum  :: numeric* -&gt; m numeric</code></pre>
<p><code>numeric*</code> represents something that should be numeric. Again, since R is dynamically typed, we have no guaranttees that the input actually is numeric. Each function takes a pure value and maps to a value wrapped in a context. <code>sum(x)</code> outputs <code>m numeric*</code>, but <code>sqrt</code> wants a <code>numeric*</code>. We need a function to mediate this. A function with the form:</p>
<pre><code>bind :: (m numeric*) -&gt; (numeric* -&gt; m numeric*) -&gt; (m numeric) 
           ^                ^                           ^
          /                /                           /
      sum(x)            sqrt                   sqrt(sum(x))</code></pre>
<p>We can express this more generally as</p>
<pre><code>bind :: m1 a -&gt; (a -&gt; m2 b) -&gt; m3 b</code></pre>
<p>Where <code>a</code> and <code>b</code> are data types. <code>m1</code>, <code>m2</code> and <code>m3</code> are contexts. Every bind operation takes 1) a value in a context (<code>m1 a</code>) and 2) a function that maps that value to <code>m2 b</code>. The prior state <code>m1</code>, as well as the intermediate state <code>m2</code>, are in the scope of the <code>bind</code> function. This allows contextual information to propagate from the <code>m1</code> to <code>m3</code>.</p>
<p>A monad is a pattern consisting of a context <code>m</code>, two functions, and three laws. The functions are <code>bind</code> and <code>return</code> (not to be confused with the <code>return</code> used to terminate a function). <code>bind</code> we have already seen. <code>return</code> takes a pure value and lifts it into a context. <code>return</code> has the form <code>a -&gt; m a</code>.</p>
<p>Before we cover the monad laws, and before we learn exactly what the monad is in the Rmonad context, we will walk step by step through one example. Rmonad uses the infix operator <code>%&gt;&gt;%</code> as <code>bind</code> (Rmonad’s <code>%&gt;&gt;%</code> corresponds to Haskell’s <code>&gt;&gt;=</code>).</p>
</div>
<div id="rmonad" class="section level2">
<h2>Rmonad</h2>
<p>The goal of Rmonad is to ditch the existing impure R cryptomonad and replace it with a clean explicit monad.</p>
<pre><code>x %&gt;&gt;% sum %&gt;&gt;% sqrt</code></pre>
<p>In place of a <code>return</code> statement</p>
<p>The initial %&gt;&gt;% operators acts as both a <code>return</code> and <code>bind</code> function. It first evaluates the</p>
<p><code>m b</code> is dependent on <code>m a</code>, not just on <code>a</code>. The <code>bind</code> function can pass information from one step in the pipeline <code>m a</code> to the next <code>m b</code>.</p>
<p><code>m2 b</code> is equal to <code>m3 b</code> only for the trivial case where the context is <code>identity</code>.</p>
<p>R users normally rely on the R session to automatically perform these binds.</p>
<p>But what exactly is <code>m</code>? In an R session, the R runtime handles errors. If one function raises an error, the error is propagated to functions that use its input.</p>
<p>In Rmonad, the <code>m</code> is an object, that catches all undefined behavior.</p>
</div>
<div id="rmonad-versus-magrittr" class="section level2">
<h2>Rmonad versus magrittr</h2>
<p>To understand the monadic nature of <code>rmonad</code> it is useful to compare it to <code>magrittr</code>. In <code>magrittr</code>, the expression <code>x %&gt;% foo %&gt;% bar</code> is the same as <code>bar(foo(x))</code>. From a monadic point of view, <code>x</code> is first implicitly raised into an ‘Identity’ monad (which is quite formless here) <code>m1 x</code>. Then</p>
<pre><code>bind :: m1 x -&gt; (x -&gt; m2 y) -&gt; m3 y</code></pre>
<p>The <code>bind</code> function above executes <code>foo</code> on <code>x</code>, yielding <code>m2 y</code>. It then reduces this to <code>m3 y</code> in the presence of <code>m1</code>. But <code>magrittr</code> passes no information from <code>m1</code> to <code>m3</code>. The pipeline is context indepent.</p>
<p>In <code>rmonad</code>, the pipeline <code>x %&gt;&gt;% foo %&gt;&gt;% bar</code> will pass a record of past events at each bind operation, thus incrementally building a graph of the pipeline.</p>
</div>
<div id="rmonad-for-haskellers" class="section level2">
<h2>Rmonad for Haskellers</h2>
<p>Only a few R expressions are pure. If a function is given an invalid input at runtime (e.g. <code>sqrt(&quot;wtf&quot;)</code>), it will die with a message printed to stderr. Rmonad wraps all R calls in a monad, intercepting all messages, so that the result of a computation is returned as a pure object.</p>
<p>The ‘R monad’ is one monad to rule the all. There is no monad stack and no support for monad transformers. In addition to error handling, The monad stores the history of every previous operation. It also performs basic benchmarking, recording the time required for each operation and the size of the returned object. All this weight might seem like a performance killer, but R programmers are used to function calls being slow, so if they care about performance, they wouldn’t use a function in a tight loop anyways.</p>
<p>The <code>return</code> function is a little complex in Rmonad. It is a special case of the <code>as_monad</code> function:</p>
<pre><code>as_monad = a -&gt; m b</code></pre>
<p>Where <code>a</code> can be one of three types</p>
<ol style="list-style-type: decimal">
<li><p>an unevaluated R expression - <code>as_monad</code> evaluates the expression, capturing any exceptions, warnings or messages. <code>as_monad</code> is used inside the <code>bind</code> function in this capacity.</p></li>
<li><p>a pure R value - acts as <code>return</code></p></li>
</ol>
<p>The <code>%&gt;&gt;%</code> operator is like the Haskell <code>&gt;&gt;=</code> operator, but with some of the sloppiness expected of a dynamic language:</p>
<pre><code>%&gt;&gt;% :: m a -&gt; (a -&gt; m b) -&gt; m b
      | a -&gt; (a -&gt; m b) -&gt; m b
      | (a -&gt; r b) -&gt; (a -&gt; m b) -&gt; m b</code></pre>
<p><code>%&gt;&gt;%</code> differs from <code>&gt;&gt;=</code> in that <code>%&gt;&gt;%</code> automatically loads the left-hand-side value into a monad.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
